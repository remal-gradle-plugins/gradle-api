name: build

on:
  push:
    branches:
    - main
    - 'test/*'
  pull_request: { }
  schedule:
  - cron: '13/15 * * * *'

concurrency:
  group: build-${{github.ref}}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  GRADLE_OPTS: -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.warning.mode=all -Dorg.gradle.logging.stacktrace=all -Dorg.gradle.daemon=true -Dhttp.keepAlive=false -Dsun.net.client.defaultConnectTimeout=15000 -Dsun.net.client.defaultReadTimeout=600000 -Dsun.net.http.retryPost=false -Dsun.io.useCanonCaches=false -Djava.awt.headless=true -Dorg.gradle.internal.launcher.welcomeMessageEnabled=false

jobs:
  prepare:
    outputs:
      matrix-includes: ${{steps.test-versions.outputs.matrix}}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Validate Gradle Wrapper
      uses: Wandalen/wretry.action/main@v3.8.0
      with:
        action: gradle/actions/wrapper-validation@v5
        attempt_limit: 3
        attempt_delay: 5000

    - name: Read min supported Gradle version
      id: min-gradle-version
      uses: remal-github-actions/read-property@v1
      with:
        file: gradle.properties
        property: 'gradle.min-version'

    - name: Get draft versions to test
      id: test-versions-draft
      uses: remal-github-actions/matrix-versions@v1
      with:
        matrix: |
          gradle:
            dependency: gradle-wrapper
            only:
            - stable-minors+current-unstable
            include:
            - '[${{steps.min-gradle-version.outputs.value}},)'
    - name: Get all versions to test
      id: test-versions
      env:
        MATRIX: ${{steps.test-versions-draft.outputs.allMatrixIncludes}}
      run: |
        MATRIX=$(jq -c '. += [{"gradle": "${{steps.min-gradle-version.outputs.value}}"}]' <<<"$MATRIX")
        echo "matrix=$MATRIX" | tee -a $GITHUB_OUTPUT

  build:
    needs:
    - prepare
    strategy:
      fail-fast: false
      matrix:
        include: ${{fromJSON(needs.prepare.outputs.matrix-includes)}}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Setup Java
      uses: actions/setup-java@v5
      with:
        distribution: temurin
        java-version: |
          25
          17
          8

    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Build
      run: |
        ./gradlew-retry-connection-timeouts build "-Pgradle.version=${{matrix.gradle}}"
